<html lang="en" layout:decorate="~{layout}">

<body>
    <div layout:fragment="content">
        <div class="container my-5">
            <div th:object="${post}">
                <h2 th:text="${post.title}">Post's Title</h2>
                <hr class="">
                <div class="d-flex justify-content-end">
                    <h6><span class="me-3" th:text="${post.author.username}">test1</span><span
                            th:text="${#temporals.format(post.createAt, 'yyyy-MM-dd HH:mm')}">2024.06.11</span></h6>
                </div>
                <div class="d-flex justify-content-end">
                    <h6 th:if="${post.updateAt != null}">
                        <span class="me-3">Update At</span><span
                            th:text="${#temporals.format(post.updateAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </h6>
                </div>

                <div class="card m-3">
                    <div th:if="${post.fileAttached==1}">
                        <div th:each="file : ${post.postImageList}">
                            <img th:src="@{|/upload/${file.storedFileName}|}" class="card-img-top d-block mx-auto"
                                alt="..." style="width:90%">
                        </div>
                    </div>
                    <div class="card-body m-3">
                        <p th:text="${post.content}">Some quick example text to build on the card title and make up the
                            bulk of the card's content.</p>

                        <div class="d-flex justify-content-end">
                            <a id="recommend" class="btn btn-sm btn-outline-dark"
                                th:data-uri="@{|/post/vote/${post.id}|}"> <span>Recommend</span>
                                <span class="badge bg-primary" th:text="${#lists.size(post.voter)}">1</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mx-3">
                    <a th:href="@{|/post/modify/${post.id}|}" class="btn btn-sm btn-outline-dark mx-1"
                        sec:authorize="isAuthenticated()"
                        th:if="${post.author != null and #authentication.getPrincipal().getUsername() == post.author.username}">Modify</a>
                    <form th:action="@{|/post/delete/${post.id}|}" method="post" sec:authorize="isAuthenticated()"
                        th:if="${post.author != null and #authentication.getPrincipal().getUsername() == post.author.username}">
                        <button class="btn btn-sm btn-outline-dark mx-1">
                            Delete
                        </button>
                    </form>
                </div>

                <h5>Comment</h5>
                <hr class="">

                <div th:each="comment, iterStat:${commentList}">
                    <div class="row m-1">
                        <div class="col-11 d-flex justify-content-between">
                            <div th:id="'profileImgAndContent-'+ ${iterStat.index}">

                                <span th:text="${comment.content}">댓글입니다</span>
                            </div>
                            <a th:href="@{|/comment/delete/${comment.id}|}" class="btn btn-sm btn-close"
                                aria-label="Close" sec:authorize="isAuthenticated()"
                                th:if="${comment.author != null and #authentication.getPrincipal().getUsername() == comment.author.username}"></a>
                        </div>
                        <div class="col-1">
                            <div class="badge bg-light text-dark text-start">
                                <div class=""><span th:text="${comment.author.username}">test2</span></div>
                                <div><span
                                        th:text="${#temporals.format(comment.createAt, 'yyyy-MM-dd HH:mm')}">2015.05.01</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="row align-items-center mt-3">
                    <div class="col">
                        <form th:object="${commentForm}" th:action="@{/comment/create(postId=${post.id})}"
                            method="post">
                            <div th:replace="~{error :: errorsFragment}"></div>
                            <div class="form-group d-flex">
                                <textarea class="form-control me-2" id="comment" rows="1"
                                    placeholder="Enter your comment" th:field="*{content}"></textarea>
                                <button type="submit" class="btn btn-sm btn-dark">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>



        </div>

        <script th:inline="javascript">

            const postId = [[${ post.id }]];

            $(document).ready(function () {

                $.ajax({
                    url: `/post/comment/profileImage/[[${post.id}]]`,
                    method: 'GET',
                    success: function (storedNameList) {
                        storedNameList.forEach((element, index) => {
                            const profileImgAndContentDiv = $(`#profileImgAndContent-${index}`);
                            const imgElement = `<img src="${element}" style="width: 30px; height: 30px;" class="rounded-circle">`;
                            profileImgAndContentDiv.prepend(imgElement);
                        });
                    },
                    error: function (error) {

                    }

                });

            });




            $("#recommend").on("click", function () {
                if (confirm("정말로 추천하시겠습니까?")) {
                    var uri = $(this).data("uri");
                    window.location.href = uri;
                } else {
                    alert("추천이 취소되었습니다.");
                }
            });
        </script>
    </div>
</body>

</html>